f<!doctype html>
<html lang="mk">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Lenovo Квиз — Откриј го идеалниот Lenovo</title>
<meta name="description" content="Одговори на 8 брзи прашања и добиј директна препорака за идеален Lenovo лаптоп." />
<style>
  :root{
    --bg:#ffffff; --text:#111827; --muted:#6b7280; --border:#e5e7eb; --card:#ffffff;
    --lenovo-red:#E2231A; --radius:16px; --shadow:0 10px 30px rgba(0,0,0,.06);
  }
  *{box-sizing:border-box} html,body{height:100%} body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}

  /* header logo centered */
  .topbar { position:sticky; top:0; z-index:50; background:#fff; border-bottom:1px solid var(--border);
            width:100%; display:flex; justify-content:center; align-items:center; padding:12px 0; }
  .topbar-inner { width:100%; display:flex; justify-content:center; align-items:center; }
  .topbar-inner img { display:block; margin:0 auto; height:58px; }

  .wrap{max-width:960px;margin:0 auto;padding:100px}
  header.hero{background:#fff}
  .hero-inner{display:flex;align-items:center;justify-content:center;min-height:38vh;padding:100px}
  .intro-card{
    background:var(--card);border:1px solid var(--border);border-radius:var(--radius);
    box-shadow:var(--shadow);width:min(820px,100%);padding:22px;text-align:center;
  }
  h1{font-size:24px;margin:8px 0 6px}
  .sub{color:var(--muted);margin:0 0 18px;font-size:14px}
  .start-btn{display:inline-flex;align-items:center;gap:10px;background:var(--lenovo-red);color:#fff;border:none;padding:12px 18px;border-radius:999px;cursor:pointer;font-weight:700;letter-spacing:.2px;text-transform:uppercase}
  .container{padding:18px 0 36px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:22px;box-shadow:var(--shadow);max-width:780px;margin:0 auto}
  .progress{height:8px;border-radius:8px;background:#f3f4f6;overflow:hidden;margin:4px 0 16px}
  .progress>div{height:100%;background:var(--lenovo-red);width:0%}
  .pill{display:inline-block;background:#f8fafc;border:1px solid var(--border);color:#6b7280;border-radius:999px;padding:6px 10px;font-size:12px;margin-bottom:8px}
  .q-title{font-size:20px;margin:6px 0 14px}
  .answers{display:grid;gap:12px}
  .btn{border:1px solid var(--border);background:#fff;color:var(--text);padding:14px 14px;border-radius:12px;font-weight:600;cursor:pointer;text-align:left;display:flex;align-items:center;gap:12px;transition:transform .03s ease, border-color .15s ease, box-shadow .15s ease, background .15s ease}
  .btn:hover{border-color:#c9ced6;box-shadow:0 4px 14px rgba(17,24,39,.06)}
  .btn.primary{display:inline-flex;align-items:center;justify-content:center;text-align:center;background:var(--lenovo-red);color:#fff;border:0}
  .icon{display:inline-flex;width:22px;height:22px;color:var(--lenovo-red)}
  .icon svg{width:22px;height:22px}
  .row{display:flex;gap:12px;flex-wrap:wrap}
  .field{flex:1 1 220px;display:flex;flex-direction:column;gap:6px}
  input[type="text"],input[type="email"],input[type="tel"]{background:#fff;border:1px solid var(--border);color:var(--text);border-radius:10px;padding:12px 12px;font-size:15px}
  label.consent{display:flex;align-items:flex-start;gap:10px;color:#374151;font-size:14px;margin:8px 0 10px}
  input[type="checkbox"]{transform:translateY(2px)}
  .error{color:#dc2626;font-size:13px;margin-top:4px;display:none}
  .hidden{display:none !important}
  .grid-2{grid-template-columns:1fr}
  @media(min-width:720px){ .grid-2{grid-template-columns:repeat(2,1fr)} }

  /* hero image */
  .hero-img{width:100%;max-width:780px;margin:0 auto 14px auto;border-radius:14px;overflow:hidden;border:1px solid var(--border)}
  .hero-img img{display:block;width:100%;height:auto}

  /* preview on finish */
  .preview{margin-top:12px; display:flex; gap:12px; align-items:center; border:1px solid var(--border); padding:12px; border-radius:12px; background:#fafafa}
  .preview img{width:88px;height:88px;object-fit:cover;border-radius:10px;border:1px solid #e5e7eb;background:#fff}
  .preview .meta{font-size:14px}
  .preview .meta .name{font-weight:700}

  /* Raise both start and quiz cards equally by 180px */
  @media (min-height: 520px) {
    #startCard, #quizCard { transform: translateY(-180px); }
  }
</style>
</head>
<body>
  <div class="topbar">
    <div class="topbar-inner">
      <img id="logoImg" src="https://cdn.worldvectorlogo.com/logos/lenovo-2.svg" alt="Lenovo" />
    </div>
  </div>

  <header class="hero">
    <div class="wrap hero-inner">
      <div class="intro-card" id="startCard">
        <div class="hero-img">
          <img id="heroImage" src="https://static.beebom.com/wp-content/uploads/2018/04/lenovi-thinkpad-x1.jpg?w=750&quality=75" alt="Lenovo Hero" />
        </div>
        <h1 id="heroTitle">Откриј го идеалниот Lenovo за тебе</h1>
        <p class="sub" id="heroSub">Одговори на 8 брзи прашања за 30 секунди и добиј директна препорака.</p>
        <button class="start-btn" id="startBtn" aria-label="Почни"><span id="startCta">ПОЧНИ</span>
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M5 12h14M13 5l7 7-7 7" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
      </div>
    </div>
  </header>

  <main class="wrap container">
    <div class="card hidden" id="quizCard">
      <div class="progress"><div id="bar"></div></div>
      <div id="quiz"></div>
    </div>
  </main>

  <!-- Netlify Forms (hidden) -->
  <form name="quiz-lead" method="POST" data-netlify="true" class="hidden" id="netlifyForm">
    <input type="hidden" name="form-name" value="quiz-lead" />
    <input type="hidden" name="full_name" id="nf_full_name" />
    <input type="hidden" name="email" id="nf_email" />
    <input type="hidden" name="phone" id="nf_phone" />
    <input type="hidden" name="consent" id="nf_consent" />
    <input type="hidden" name="scores_legion" id="nf_legion" />
    <input type="hidden" name="scores_thinkbook14" id="nf_thinkbook14" />
    <input type="hidden" name="scores_thinkpadE16" id="nf_thinkpadE16" />
    <input type="hidden" name="scores_v15" id="nf_v15" />
    <input type="hidden" name="primaryLane" id="nf_lane" />
    <input type="hidden" name="outcome" id="nf_outcome" />
    <input type="hidden" name="persona" id="nf_persona" />
    <input type="hidden" name="page" id="nf_page" />
    <button type="submit" id="nf_submit">submit</button>
  </form>

<script>
/* Defaults (fallback ако нема localStorage) */
const PRODUCT_URLS = {
  legion: "https://kupilenovo.mk/categories/_laptops/83F500DJRM-Legion-Legion-Pro-7-16IAX10H-Eclipse-Black---Ultra-9-275HX,-64GB,-2TB-NVMe,-RTX-5080-16GB,-16-,-DOS",
  thinkbook14: "REPLACE_WITH_THINKBOOK_14_G7_URL",
  thinkpadE16: "https://kupilenovo.mk/categories/_laptops/21SR004GRI-Lenovo-ThinkPad-E16-Gen-3-Black---Ultra-7-255H,-16GB,-1TB,-16-,-DOS",
  v15: "REPLACE_WITH_V15_G4_ABP_URL",
  fallback: "REPLACE_WITH_LOW_PRICE_CATEGORY_URL"
};
const PRODUCT_IMAGES = {
  legion: "https://kupilenovo.mk/2025/07/10/Legion_Pro_7_16IAX10H_CT1_01.jpg",
  thinkpadE16: "https://kupilenovo.mk/2024/11/29/ThinkPad_E16_Gen_2_AMD_CT1_01.jpg",
  thinkbook14: "https://via.placeholder.com/300x200?text=ThinkBook+14+G7",
  v15: "https://via.placeholder.com/300x200?text=Lenovo+V15+G4"
};
const PRODUCT_COPY = {
  legion: { name: "Legion Pro 7 16IAX10H", why: "AAA гејминг, 240 Hz OLED 16″, врвен CPU/GPU, 64 GB/2 TB — без компромис." },
  thinkbook14: { name: "ThinkBook 14 G7 IML", why: "Лесен за училиште/факултет и кафулиња, 14″ 16:10, долга автономија, одлична тастатура." },
  thinkpadE16: { name: "ThinkPad E16 Gen 3", why: "Бизнис доверливост, повеќе порти, силен процесор, 16″ простор за Excel, презентации и повици." },
  v15: { name: "Lenovo V15 G4 ABP", why: "Одличен однос цена/перформанси — идеален за Office, Zoom, е-пошта и CRM." }
};

/* Икони (исти keys како во админ) */
const ICONS = {
  game:'<svg viewBox="0 0 24 24"><path fill="currentColor" d="M6 8h12a4 4 0 0 1 4 4v3a3 3 0 1 1-6 0h-8a3 3 0 1 1-6 0v-3a4 4 0 0 1 4-4Zm2 3H6v2H4v2h2v2h2v-2h2v-2H8v-2Z"/></svg>',
  school:'<svg viewBox="0 0 24 24"><path fill="currentColor" d="M12 3 1 9l11 6 10-5V9L12 3Zm0 13L3.7 11 12 7l8.3 4L12 16Z"/></svg>',
  brief:'<svg viewBox="0 0 24 24"><path fill="currentColor" d="M9 3h6a2 2 0 0 1 2 2v2h3a2 2 0 0 1 2 2v9a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3V9a2 2 0 0 1 2-2h3Zm0 4h6V5H9v2Z"/></svg>',
  bolt:'<svg viewBox="0 0 24 24"><path fill="currentColor" d="M13 2 3 14h7l-1 8 11-12h-7l0-8Z"/></svg>',
  comfy:'<svg viewBox="0 0 24 24"><path fill="currentColor" d="M4 12h16a2 2 0  1 1 2 2v6h-2v-2H4v2H2v-6a2 2 0 0 1 2-2Z"/></svg>',
  value:'<svg viewBox="0 0 24 24"><path fill="currentColor" d="M12 2a10 10 0  1 0 .001 20.001A10 10 0 0 0 12 2Zm1 5h-2v2H8v2h3v4H9v2h3v2h2v-2h1v-2h-1v-4h3V9h-3V7Z"/></svg>',
  display16:'<svg viewBox="0 0 24 24"><path fill="currentColor" d="M3 5h18v10H3zM8 19h8v-2H8z"/></svg>',
  display15:'<svg viewBox="0 0 24 24"><path fill="currentColor" d="M4 6h16v9H4zM9 19h6v-2H9z"/></svg>',
  display14:'<svg viewBox="0 0 24 24"><path fill="currentColor" d="M5 7h14v8H5zM10 19h4v-2h-4z"/></svg>',
  desk:'<svg viewBox="0 0 24 24"><path fill="currentColor" d="M2 10h20v4h-2v6h-2v-6H6v6H4v-6H2v-4Z"/></svg>',
  campus:'<svg viewBox="0 0 24 24"><path fill="currentColor" d="M2 10 12 5l10 5-10 5-10-5Zm3 5h14v4H5v-4Z"/></svg>',
  sheets:'<svg viewBox="0 0 24 24"><path fill="currentColor" d="M7 3h10a2 2 0 0 1 2 2v14l-5-3-5 3V5a2 2 0 0 1 2-2Z"/></svg>',
  trophy:'<svg viewBox="0 0 24 24"><path fill="currentColor" d="M4 4h16v3h2a5 5 0 0 1-5 5h-2a4 4 0 0 1-8 0H5A5 5 0 0 1 3 7h1V4Zm6 12h4v2h-4v-2Z"/></svg>',
  bulb:'<svg viewBox="0 0 24 24"><path fill="currentColor" d="M12 2a7 7 0 0 1 4 13v3h-8v-3a7 7 0 0 1 4-13Zm-2 18h4v2h-4v-2Z"/></svg>',
  home:'<svg viewBox="0 0 24 24"><path fill="currentColor" d="M3 11 12 4l9 7v8h-6v-5H9v5H3v-8Z"/></svg>',
  office:'<svg viewBox="0 0 24 24"><path fill="currentColor" d="M4 3h8v18H4zM14 7h6v14h-6z"/></svg>',
  rocket:'<svg viewBox="0 0 24 24"><path fill="currentColor" d="M12 2c4 0 7 3 7 7l-4 4-3-1-1-3 4-4C14 3 12 2 12 2ZM5 19l2-5 3 3-5 2Z"/></svg>',
  check:'<svg viewBox="0 0 24 24"><path fill="currentColor" d="M9 16.2 4.8 12l-1.4 1.4L9 19 21 7l-1.4-1.4z"/></svg>',
  toolbox:'<svg viewBox="0 0 24 24"><path fill="currentColor" d="M7 7V5a2 2 0 0 1 2-2h6a2 2 0 0 1 2 2v2h3a2 2 0 0 1 2 2v9H2V9a2 2 0 0 1 2-2h3Zm2 0h6V5H9v2Z"/></svg>',
  target:'<svg viewBox="0 0 24 24"><path fill="currentColor" d="M12 2a10 10 0 1 0 10 10h-2a8 8 0 1 1-8-8V2Zm0 4a6 6 0 1 0 6 6h-2a4 4 0 1 1-4-4V6Z"/></svg>'
};

/* State */
const scores = { legion:0, thinkbook14:0, thinkpadE16:0, v15:0 };
let primaryLane = null;
let currentIndex = 0;
let choseValueQ2 = false;
let choseValueQ5 = false;
let explicitCheapestFlag = false;

/* Questions default (ќе се презапише ако постои конфиг) */
let QUESTIONS = [
  { id:1, title:"П1. За што ти е најпотребен лаптопот?", answers:[
    {text:"Гејминг", icon:"game", customSvg:""},
    {text:"Училиште/Факултет", icon:"school", customSvg:""},
    {text:"Работа", icon:"brief", customSvg:""}
  ]},
  { id:2, title:"П2. Што ти е најважно во моментов?", answers:[
    {text:"Максимални перформанси", icon:"bolt", customSvg:""},
    {text:"Удобност за цел ден", icon:"comfy", customSvg:""},
    {text:"Најдобра вредност за буџетот", icon:"value", customSvg:""}
  ]},
  { id:3, title:"П3. Каков екран ти одговара?", answers:[
    {text:"Голем и имерзивен 16″", icon:"display16", customSvg:""},
    {text:"Стандарден 15–16″", icon:"display15", customSvg:""},
    {text:"Компактен и лесен 14″", icon:"display14", customSvg:""}
  ]},
  { id:4, title:"П4. Твојот ден најчесто изгледа вака:", answers:[
    {text:"Долги фокус-сесии на биро", icon:"desk", customSvg:""},
    {text:"Се движам меѓу предавања и кафулиња", icon:"campus", customSvg:""},
    {text:"Низа повици, документи и табели", icon:"sheets", customSvg:""}
  ]},
  { id:5, title:"П5. За работа — што ти значи повеќе?", answers:[
    {text:"Премиум изработка, тастатура и моќ за тежок мултитаск", icon:"trophy", customSvg:""},
    {text:"Најдобра вредност што ја завршува работата", icon:"bulb", customSvg:""}
  ], condition:()=> primaryLane === "work" },
  { id:6, title:"П6. Каде најчесто ќе го користиш?", answers:[
    {text:"Дома или гејминг-сетап", icon:"home", customSvg:""},
    {text:"Кампус и кафулиња", icon:"campus", customSvg:""},
    {text:"Канцеларија и средби со клиенти", icon:"office", customSvg:""}
  ]},
  { id:7, title:"П7. Избери реченица со која се поистоветуваш:", answers:[
    {text:"Сакам нешто незапирливо", icon:"rocket", customSvg:""},
    {text:"Сакам нешто лесно и сигурно", icon:"check", customSvg:""},
    {text:"Сакам нешто професионално и доверливо", icon:"toolbox", customSvg:""},
    {text:"Сакам паметна вредност", icon:"value", customSvg:""}
  ]},
  { id:8, title:"Последен чекор — остави контакт за препораката", lead:true }
];
function visibleQuestions(){ return QUESTIONS.filter(q => !q.condition || q.condition()); }

/* UI refs */
const $quiz = document.getElementById("quiz");
const $bar = document.getElementById("bar");
const $quizCard = document.getElementById("quizCard");
const $logo = document.getElementById("logoImg");
const $heroImage = document.getElementById("heroImage");
const $heroTitle = document.getElementById("heroTitle");
const $heroSub = document.getElementById("heroSub");
const $startCta = document.getElementById("startCta");

/* Load overrides from localStorage */
(function applyConfig(){
  try{
    const raw = localStorage.getItem('lenovoQuizConfig'); if(!raw) return;
    const cfg = JSON.parse(raw);

    // Logo
    if(cfg.logo){
      if(cfg.logo.url){ $logo.src = cfg.logo.url; }
      if(cfg.logo.data){ $logo.src = cfg.logo.data; } // data има приоритет ако го поставиш
    }
    // Hero content
    if(cfg.hero){
      if(cfg.hero.title) $heroTitle.textContent = cfg.hero.title;
      if(cfg.hero.sub) $heroSub.textContent = cfg.hero.sub;
      if(cfg.hero.cta) $startCta.textContent = cfg.hero.cta;
      if(cfg.hero.image){
        if(cfg.hero.image.url) $heroImage.src = cfg.hero.image.url;
        if(cfg.hero.image.data) $heroImage.src = cfg.hero.image.data;
      }
    }
    // Finish CTA
    window.FINISH_CTA = (cfg.finish && cfg.finish.cta) ? cfg.finish.cta : "Продолжи кон препорачан модел";

    // URLs/Images
    if(cfg.productUrls){
      Object.assign(PRODUCT_URLS, cfg.productUrls);
    }
    if(cfg.productImages){
      Object.assign(PRODUCT_IMAGES, cfg.productImages);
    }

    // Questions (со икони)
    if(cfg.questions && Array.isArray(cfg.questions)){
      QUESTIONS = cfg.questions.map((q,i)=>{
        if(q.condition === 'lead'){ return { id:8, title:q.title, lead:true, answers:[] }; }
        const id = i+1;
        const base = { id, title:q.title, answers:(q.answers||[]).map(a=>({text:a.text, icon:a.icon||'', customSvg:a.customSvg||''})) };
        if(q.condition === 'work'){ base.condition = ()=> primaryLane === "work"; }
        return base;
      });
    }
  }catch(e){}
})();

document.getElementById("startBtn").addEventListener("click", ()=>{
  document.getElementById("startCard").classList.add("hidden");
  $quizCard.classList.remove("hidden");
  render();
});

function setProgress(){
  const vis = visibleQuestions();
  const step = Math.min(currentIndex+1, vis.length); // човечки индекс
  // Барање: да биде „Чекор X“ (без „од N“) → ќе го ставаме во pill
  // прогрес-бар сепак ќе го движиме според чекорот
  const pct = Math.round((currentIndex) / (vis.length - 1) * 100);
  $bar.style.width = pct + "%";
}

function iconMarkup(key, custom){
  if(custom && custom.trim().startsWith('<svg')) return custom;
  if(!key) return ICONS['target'];
  return ICONS[key] || ICONS['target'];
}

function render(){
  const vis = visibleQuestions();
  const q = vis[currentIndex];
  setProgress();
  if(!q){ renderDone(); return; }

  if(q.lead){
    const winner = predictWinner();
    const p = (winner && PRODUCT_COPY[winner]) || null;
    const img = (winner && PRODUCT_IMAGES[winner]) || "";
    const preview = `
      <div class="preview">
        ${img ? `<img src="${img}" alt="${p ? p.name : 'Lenovo'}">` : ``}
        <div class="meta">
          <div class="name">${p ? p.name : 'Lenovo'}</div>
          <div class="why">${p ? escapeHtml(p.why) : 'Вашата препорака е подготвена.'}</div>
        </div>
      </div>
    `;

    $quiz.innerHTML = `
      <div class="pill">Чекор ${currentIndex + 1}</div>
      <div class="q-title">${q.title}</div>
      ${preview}
      <div class="answers">
        <div class="row">
          <div class="field">
            <label>Име и презиме</label>
            <input id="q8_name" type="text" placeholder="Име и презиме" />
            <div class="error" id="err_name">Внеси име и презиме</div>
          </div>
          <div class="field">
            <label>Е-пошта</label>
            <input id="q8_email" type="email" placeholder="Е-пошта" />
            <div class="error" id="err_email">Внеси валидна е-пошта</div>
          </div>
          <div class="field">
            <label>Телефон <span class="small" style="font-weight:400">(опционално)</span></label>
            <input id="q8_phone" type="tel" placeholder="Телефон (опционално)" />
          </div>
        </div>
        <label class="consent">
          <input id="q8_consent" type="checkbox" />
          <span>Се согласувам да бидам контактиран/а за препораката, цените и понудите.</span>
        </label>
        <div class="error" id="err_consent">Потврди согласност</div>
        <button class="btn primary" id="cta">${window.FINISH_CTA || "Продолжи кон препорачан модел"}</button>
      </div>
    `;
    document.getElementById("cta").addEventListener("click", submitAndRedirect);
    return;
  }

  const answers = q.answers.map((a,i) =>
    `<button class="btn" data-q="${q.id}" data-a="${a.text.replace(/"/g,'&quot;')}">
       <span class="icon">${iconMarkup(a.icon, a.customSvg)}</span>
       <span>${a.text}</span>
     </button>`
  ).join("");

  $quiz.innerHTML = `
    <div class="pill">Чекор ${currentIndex + 1}</div>
    <div class="q-title">${q.title}</div>
    <div class="answers grid-2" id="answers">${answers}</div>
  `;
  document.getElementById("answers").addEventListener("click", (e)=>{
    const btn = e.target.closest("button[data-q]"); if(!btn) return;
    const qId = Number(btn.getAttribute("data-q"));
    const aLabel = btn.getAttribute("data-a");
    handleAnswer(qId, aLabel);
    currentIndex++; render();
  });
}

function escapeHtml(s){ return s.replace(/[&<>"']/g, c=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"}[c])); }

/* scoring */
function addScore(key, pts=1){ if(scores[key] !== undefined) scores[key]+=pts; }
function handleAnswer(q, a){
  if(q===1){
    if(a==="Гејминг"){ primaryLane="gaming"; addScore("legion",5); }
    if(a==="Училиште/Факултет"){ primaryLane="school"; addScore("thinkbook14",5); }
    if(a==="Работа"){ primaryLane="work"; addScore("thinkpadE16",3); addScore("v15",3); }
  }
  if(q===2){
    if(a==="Максимални перформанси"){ addScore("legion",2); addScore("thinkpadE16",1); }
    if(a==="Удобност за цел ден"){ addScore("thinkbook14",1); addScore("thinkpadE16",1); }
    if(a==="Најдобра вредност за буџетот"){ addScore("v15",2); choseValueQ2 = true; }
  }
  if(q===3){
    if(a.startsWith("Голем и имерзивен 16")){ addScore("legion",1); addScore("thinkpadE16",1); }
    if(a.startsWith("Стандарден 15")){ addScore("v15",1); addScore("thinkpadE16",1); }
    if(a.startsWith("Компактен и лесен 14")){ addScore("thinkbook14",2); }
  }
  if(q===4){
    if(a.startsWith("Долги фокус")){ addScore("legion",1); addScore("thinkpadE16",1); }
    if(a.startsWith("Се движам")){ addScore("thinkbook14",2); }
    if(a.startsWith("Низа повици")){ addScore("thinkpadE16",2); addScore("v15",1); }
  }
  if(q===5){
    if(a.startsWith("Премиум изработка")){ addScore("thinkpadE16",4); }
    if(a.startsWith("Најдобра вредност")){ addScore("v15",4); choseValueQ5 = true; }
  }
  if(q===6){
    if(a.startsWith("Дома или гејминг")){ addScore("legion",1); }
    if(a.startsWith("Кампус и кафулиња")){ addScore("thinkbook14",1); }
    if(a.startsWith("Канцеларија и средби")){ addScore("thinkpadE16",1); addScore("v15",1); }
  }
  if(q===7){
    if(a.includes("незапирливо")){ addScore("legion",1); }
    if(a.includes("лесно и сигурно")){ addScore("thinkbook14",1); }
    if(a.includes("професионално и доверливо")){ addScore("thinkpadE16",1); }
    if(a.includes("паметна вредност")){ addScore("v15",1); }
  }
  if(typeof a === "string" && a.toLowerCase().includes("најефтино можно")) explicitCheapestFlag = true;
}

function getParam(name){ const p = new URLSearchParams(location.search); return p.get(name) || ""; }
function buildUTM(outcomeSlug, persona){
  const src = getParam("utm_source") || "meta";
  const med = getParam("utm_medium") || "paid";
  return `utm_source=${encodeURIComponent(src)}&utm_medium=${encodeURIComponent(med)}&utm_campaign=quiz&utm_content=outcome_${encodeURIComponent(outcomeSlug)}&utm_term=persona_${encodeURIComponent(persona)}`;
}

function predictWinner(){
  const s = { ...scores };
  const maxScore = Math.max(s.legion, s.thinkbook14, s.thinkpadE16, s.v15);
  let tied = Object.keys(s).filter(k => s[k] === maxScore);
  if(tied.length===1) return tied[0];
  if(tied.includes("legion")) return "legion";
  if(tied.length===2 && tied.includes("thinkpadE16") && tied.includes("v15")) return "thinkpadE16";
  const workInTie = tied.some(k => k==="thinkpadE16"||k==="v15");
  if(tied.includes("thinkbook14") && workInTie){ tied = tied.filter(k => k!=="thinkbook14"); }
  if(tied.includes("v15")) return "v15";
  return tied[0];
}
function decideWinner(){
  if(explicitCheapestFlag) return "fallback";
  const maxScore = Math.max(scores.legion, scores.thinkbook14, scores.thinkpadE16, scores.v15);
  let tied = Object.keys(scores).filter(k => scores[k] === maxScore);
  if(tied.length===1) return tied[0];
  if(tied.includes("legion")) return "legion";
  if(tied.length===2 && tied.includes("thinkpadE16") && tied.includes("v15")) return "thinkpadE16";
  const workInTie = tied.some(k => k==="thinkpadE16"||k==="v15");
  if(tied.includes("thinkbook14") && workInTie){
    if(primaryLane==="school") return "thinkbook14";
    tied = tied.filter(k => k!=="thinkbook14");
  }
  if(choseValueQ2 && choseValueQ5 && tied.includes("v15")) return "v15";
  for(const k of ["legion","thinkpadE16","v15","thinkbook14"]){ if(tied.includes(k)) return k; }
  return "legion";
}
function personaFor(winner){ if(winner==="legion") return "gamer"; if(winner==="thinkbook14") return "student"; return "work"; }

function validateLead(){
  const name = document.querySelector("#q8_name").value.trim();
  const email = document.querySelector("#q8_email").value.trim();
  const consent = document.querySelector("#q8_consent").checked;
  const show = (id, v)=> document.getElementById(id).style.display = v ? "block" : "none";
  let ok = true;
  show("err_name", !name);
  show("err_email", !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email));
  show("err_consent", !consent);
  if(!name || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email) || !consent) ok=false; // телефон НЕ е задолжителен
  return ok;
}

async function submitAndRedirect(){
  if(!validateLead()) return;
  const winner = decideWinner();
  const persona = personaFor(winner);
  const outcomeSlug = winner === "thinkpadE16" ? "thinkpadE16"
                    : winner === "thinkbook14" ? "thinkbook14"
                    : winner === "v15" ? "v15"
                    : winner === "fallback" ? "fallback"
                    : "legion";
  const utm = buildUTM(outcomeSlug, persona);
  const base = PRODUCT_URLS[winner] || PRODUCT_URLS.fallback || "/";
  const finalUrl = base + (base.includes("?") ? "&" : "?") + utm;

  try{
    // Netlify form
    document.getElementById("nf_full_name").value = document.querySelector("#q8_name").value.trim();
    document.getElementById("nf_email").value = document.querySelector("#q8_email").value.trim();
    document.getElementById("nf_phone").value = (document.querySelector("#q8_phone").value || "").trim();
    document.getElementById("nf_consent").value = document.querySelector("#q8_consent").checked ? "yes" : "no";
    document.getElementById("nf_legion").value = String(scores.legion);
    document.getElementById("nf_thinkbook14").value = String(scores.thinkbook14);
    document.getElementById("nf_thinkpadE16").value = String(scores.thinkpadE16);
    document.getElementById("nf_v15").value = String(scores.v15);
    document.getElementById("nf_lane").value = primaryLane || "";
    document.getElementById("nf_outcome").value = outcomeSlug;
    document.getElementById("nf_persona").value = persona;
    document.getElementById("nf_page").value = location.href;
    const form = document.getElementById("netlifyForm");
    const fd = new FormData(form);
    await fetch("/", { method:"POST", body:fd });
  }catch(e){}

  try{ window.dataLayer = window.dataLayer || []; window.dataLayer.push({event:"quiz_outcome", outcome:outcomeSlug, persona}); }catch(_){}

  const btn = document.getElementById("cta");
  if(btn){ btn.disabled = true; btn.textContent = "Пренасочување…"; }
  setTimeout(()=>{ window.location.href = finalUrl; }, 2000);
}

/* keyboard 1-4 quick select */
document.addEventListener("keydown", (e)=>{
  if(e.key>="1"&&e.key<="4"){
    const buttons=[...document.querySelectorAll("#answers .btn")];
    const idx=Number(e.key)-1; if(buttons[idx]) buttons[idx].click();
  }
});

function renderDone(){
  $quiz.innerHTML = `<div class="q-title">Готово</div><p class="sub">Пренасочуваме…</p>`;
}
</script>
</body>
</html>
